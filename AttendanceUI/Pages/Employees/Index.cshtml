@page "{pageNum:int?}"
@model AttendanceUI.Pages.Employees.IndexModel
@{
    ViewData["Title"] = "Employees";
}

<form id="ajaxTokenForm" style="display:none">@Html.AntiForgeryToken()</form>

@if (TempData["SetNameResult"] is string msg)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @msg
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Page Header -->
<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h4 class="mb-1 fw-bold">Employees</h4>
        <p class="text-muted mb-0 small">Manage your organization's workforce</p>
    </div>
    <a class="btn btn-primary" asp-page="./Create">
        <i class="bi bi-person-plus-fill me-2"></i>Add Employee
    </a>
</div>

<!-- Main Card -->
<div class="card">
    <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-3">
        <h5 class="mb-0">Employee List
            <span class="badge text-bg-secondary ms-2 fw-normal">@Model.TotalCount total</span>
        </h5>

        <!-- Search and Filter -->
        <form method="get" class="d-flex flex-wrap gap-2 align-items-center" id="searchForm">
            <div class="input-group" style="width:280px;">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" name="SearchQuery" class="form-control"
                       placeholder="Search name, ID, phone..."
                       value="@Model.SearchQuery" id="searchInput" autocomplete="off" />
            </div>
            <select name="StatusFilter" class="form-select" id="statusFilter" style="width:160px;">
                <option value="all" selected="@(Model.StatusFilter == "all" || string.IsNullOrEmpty(Model.StatusFilter))">All Status</option>
                <option value="active" selected="@(Model.StatusFilter == "active")">Active Only</option>
                <option value="inactive" selected="@(Model.StatusFilter == "inactive")">Inactive Only</option>
            </select>
            @if (!string.IsNullOrWhiteSpace(Model.SearchQuery) || (!string.IsNullOrWhiteSpace(Model.StatusFilter) && Model.StatusFilter != "all"))
            {
                <a href="@Url.Page("./Index")" class="btn btn-outline-secondary" title="Clear">
                    <i class="bi bi-x-lg"></i>
                </a>
            }
        </form>
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-modern align-middle mb-0">
                <thead>
                    <tr>
                        <th class="ps-4">ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Designation</th>
                        <th>Device</th>
                        <th>Status</th>
                        <th class="text-end pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Employees.Count == 0)
                {
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="bi bi-people fs-1 d-block mb-2 opacity-25"></i>
                            No employees found. Try adjusting your search or filters.
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var e in Model.Employees)
                    {
                        var isActive = string.Equals(e.Status, "active", StringComparison.OrdinalIgnoreCase);
                        var btnLabel = e.DeviceSynced == 1 ? "Resync" : "Set in Device";
                        var btnClass = e.DeviceSynced == 1 ? "btn-outline-warning" : "btn-warning";

                        <tr>
                            <td class="ps-4 text-muted">#@e.EmployeeId</td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="avatar-circle">
                                        @(string.IsNullOrEmpty(e.EmployeeName) ? "?" : e.EmployeeName[0].ToString().ToUpper())
                                    </div>
                                    <div>
                                        <div class="fw-semibold">@e.EmployeeName</div>
                                        @if (!string.IsNullOrEmpty(e.Phone))
                                        {
                                            <div class="small text-muted">@e.Phone</div>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td>@(e.Department?.DepartmentName ?? "—")</td>
                            <td>@(e.Designation?.DesignationName ?? "—")</td>
                            <td>
                                <div class="device-status" data-employee-id="@e.EmployeeId">
                                @if (e.DeviceSynced == 1)
                                {
                                    <span class="badge text-bg-success">In Machine</span>
                                }
                                else
                                {
                                    <span class="badge text-bg-secondary">Not in Machine</span>
                                }
                                </div>
                                @if (!string.IsNullOrWhiteSpace(e.DeviceSyncError))
                                {
                                    <div class="text-danger mt-1" style="font-size:0.75rem;">@e.DeviceSyncError</div>
                                }
                            </td>
                            <td>
                                <span class="badge rounded-pill @(isActive ? "text-bg-success" : "text-bg-secondary")">
                                    @((e.Status ?? "unknown").ToUpper())
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <div class="d-flex gap-1 justify-content-end">
                                    <a class="btn btn-sm btn-outline-primary" asp-page="./Edit" asp-route-id="@e.EmployeeId">Edit</a>

                                    <button type="button"
                                            class="btn btn-sm @(isActive ? "btn-outline-secondary" : "btn-outline-success") toggle-status-ajax"
                                            data-employee-id="@e.EmployeeId"
                                            data-current-status="@(isActive ? "active" : "inactive")">
                                        @(isActive ? "Deactivate" : "Activate")
                                    </button>

                                    <button type="button" class="btn btn-sm @btnClass set-name-ajax" data-employee-id="@e.EmployeeId">
                                        @btnLabel
                                    </button>

                                    <form method="post" asp-page-handler="Delete" asp-route-id="@e.EmployeeId" class="d-inline"
                                          onsubmit="return confirm('Delete this employee? This also removes them from the biometric device.');">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination Footer -->
    @if (Model.TotalPages > 1 || Model.TotalCount > 0)
    {
        <div class="card-footer d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
            <div class="small text-muted">
                Showing @Model.Employees.Count of @Model.TotalCount employees
            </div>
            @if (Model.TotalPages > 1)
            {
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        @{
                            var queryParams = new Dictionary<string, string?>();
                            if (!string.IsNullOrWhiteSpace(Model.SearchQuery))
                                queryParams["SearchQuery"] = Model.SearchQuery;
                            if (!string.IsNullOrWhiteSpace(Model.StatusFilter) && Model.StatusFilter != "all")
                                queryParams["StatusFilter"] = Model.StatusFilter;
                        }
                        <li class="page-item @(Model.CurrentPage <= 1 ? "disabled" : "")">
                            @{ queryParams["pageNum"] = (Model.CurrentPage - 1).ToString(); }
                            <a class="page-link" href="@Url.Page("./Index", queryParams)">« Prev</a>
                        </li>
                        @{
                            int start = Math.Max(1, Model.CurrentPage - 2);
                            int end = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                            for (int i = start; i <= end; i++)
                            {
                                queryParams["pageNum"] = i.ToString();
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Page("./Index", queryParams)">@i</a>
                                </li>
                            }
                        }
                        <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")">
                            @{ queryParams["pageNum"] = (Model.CurrentPage + 1).ToString(); }
                            <a class="page-link" href="@Url.Page("./Index", queryParams)">Next »</a>
                        </li>
                    </ul>
                </nav>
            }
        </div>
    }
</div>

@section Scripts {
<script>
    // Search debounce + auto-submit on filter change
    (function () {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const form = document.getElementById('searchForm');
        let timeout;

        searchInput?.addEventListener('input', function () {
            clearTimeout(timeout);
            timeout = setTimeout(() => form.submit(), 500);
        });
        statusFilter?.addEventListener('change', () => form.submit());

        if (searchInput?.value) {
            const v = searchInput.value;
            searchInput.focus();
            searchInput.setSelectionRange(v.length, v.length);
        }
    })();

    // AJAX helpers
    (function () {
        function authHeaders() {
            const t = window.authToken || localStorage.getItem('authToken') || '';
            return t ? { 'Accept': 'application/json', 'Authorization': 'Bearer ' + t } : { 'Accept': 'application/json' };
        }

        function showToast(type, msg) {
            const el = document.createElement('div');
            el.className = 'position-fixed top-0 end-0 p-3';
            el.style.zIndex = 9999;
            el.innerHTML = `<div class="toast show text-white bg-${type === 'success' ? 'success' : 'danger'} border-0">
                <div class="d-flex"><div class="toast-body">${msg}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.position-fixed').remove()"></button></div></div>`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        // Device sync
        document.addEventListener('click', async function (e) {
            const btn = e.target.closest('.set-name-ajax');
            if (!btn) return;
            const id = btn.dataset.employeeId;
            const orig = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            try {
                const res = await fetch(`/api/device/set-user/${encodeURIComponent(id)}`, {
                    method: 'POST', headers: authHeaders(), credentials: 'same-origin',
                    signal: AbortSignal.timeout(10000)
                });
                const text = await res.text();
                const row = btn.closest('tr');
                const statusDiv = row?.querySelector('.device-status');
                if (res.ok) {
                    if (statusDiv) statusDiv.innerHTML = '<span class="badge text-bg-success">In Machine</span>';
                    btn.innerHTML = 'Resync';
                    btn.classList.replace('btn-warning', 'btn-outline-warning');
                    showToast('success', text || 'Registered on device');
                } else {
                    if (statusDiv) statusDiv.innerHTML = '<span class="badge text-bg-secondary">Error</span>';
                    btn.innerHTML = 'Retry';
                    showToast('danger', text || `HTTP ${res.status}`);
                }
            } catch (err) {
                btn.innerHTML = orig;
                showToast('danger', err.name === 'TimeoutError' ? 'Request timed out' : err.message);
            } finally {
                btn.disabled = false;
            }
        });

        // Toggle status
        document.addEventListener('click', async function (e) {
            const btn = e.target.closest('.toggle-status-ajax');
            if (!btn) return;
            const id = btn.dataset.employeeId;
            const current = btn.dataset.currentStatus;
            const next = current === 'active' ? 'inactive' : 'active';
            const orig = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            try {
                const token = document.querySelector('#ajaxTokenForm input[name="__RequestVerificationToken"]')?.value || '';
                const form = new FormData();
                form.append('__RequestVerificationToken', token);
                const res = await fetch(`/Employees?handler=ToggleStatus&id=${encodeURIComponent(id)}`, {
                    method: 'POST', body: form, credentials: 'same-origin'
                });
                if (res.ok) {
                    const data = await res.json();
                    btn.dataset.currentStatus = next;
                    btn.innerHTML = next === 'active' ? 'Deactivate' : 'Activate';
                    btn.classList.remove('btn-outline-secondary', 'btn-outline-success');
                    btn.classList.add(next === 'active' ? 'btn-outline-secondary' : 'btn-outline-success');
                    const row = btn.closest('tr');
                    const badge = row?.querySelector('td:nth-child(6) .badge');
                    if (badge) {
                        badge.textContent = next.toUpperCase();
                        badge.className = `badge rounded-pill ${next === 'active' ? 'text-bg-success' : 'text-bg-secondary'}`;
                    }
                    showToast('success', data.message || 'Status updated');
                } else {
                    btn.innerHTML = orig;
                    showToast('danger', 'Failed to update status');
                }
            } catch (err) {
                btn.innerHTML = orig;
                showToast('danger', err.message);
            } finally {
                btn.disabled = false;
            }
        });
    })();
</script>
}
