@page
@model AttendanceUI.Pages.Loans.Applications.CreateModel

@{
    ViewData["Title"] = "Apply for Loan";
}

<div class="container mt-4">
    <h1>Apply for Loan</h1>
    <hr />
    <div class="row">
        <div class="col-md-6">
            <form method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                
                <div class="form-group mb-3">
                    <label asp-for="LoanApplication.EmployeeId" class="control-label">Employee</label>
                    <select asp-for="LoanApplication.EmployeeId" class="form-control" asp-items="ViewBag.EmployeeId">
                        <option value="">-- Select Employee --</option>
                    </select>
                    <span asp-validation-for="LoanApplication.EmployeeId" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="LoanApplication.LoanTypeId" class="control-label">Loan Type</label>
                    <select asp-for="LoanApplication.LoanTypeId" class="form-control" asp-items="ViewBag.LoanTypeId">
                        <option value="">-- Select Loan Type --</option>
                    </select>
                    <span asp-validation-for="LoanApplication.LoanTypeId" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="LoanApplication.LoanAmount" class="control-label">Loan Amount (₹)</label>
                    <input asp-for="LoanApplication.LoanAmount" class="form-control" type="number" step="0.01" min="1" />
                    <span asp-validation-for="LoanApplication.LoanAmount" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="LoanApplication.InstallmentAmount" class="control-label">Monthly EMI (₹)</label>
                    <input asp-for="LoanApplication.InstallmentAmount" id="emiInput" class="form-control" type="number" step="0.01" min="1" />
                    <span asp-validation-for="LoanApplication.InstallmentAmount" class="text-danger"></span>
                    <div id="monthsFeedback" class="mt-1 small text-info fw-bold" style="display:none;">
                        Estimated Duration: <span id="calcMonths">0</span> months
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="LoanApplication.StartDate" class="control-label">Start Date</label>
                    <input asp-for="LoanApplication.StartDate" class="form-control" type="date" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    <span asp-validation-for="LoanApplication.StartDate" class="text-danger"></span>
                    <small class="text-muted">For new loans: when deductions start. For ongoing: original start date.</small>
                </div>

                <!-- Migration Support (NEW) -->
                <div class="card border-primary bg-light mb-3">
                    <div class="card-body p-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="isOngoing" />
                            <label class="form-check-label fw-bold text-primary" for="isOngoing">Is this an ongoing loan?</label>
                        </div>
                        <div id="migrationField" style="display:none;">
                            <label asp-for="LoanApplication.StartingPaidInstallments" class="control-label small fw-bold">Installments Already Paid</label>
                            <input asp-for="LoanApplication.StartingPaidInstallments" class="form-control form-control-sm" type="number" min="0" value="0" />
                            <small class="text-muted">These will be marked as "Paid" automatically.</small>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="LoanApplication.Reason" class="control-label">Reason</label>
                    <textarea asp-for="LoanApplication.Reason" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="LoanApplication.Reason" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <input type="submit" value="Submit Application" class="btn btn-primary" />
                    <a asp-page="Index" class="btn btn-secondary">Back to List</a>
                </div>
            </form>
        </div>
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title">Loan Information</h5>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-info-circle text-primary"></i> <strong>Interest-Free Loans</strong></li>
                        <li class="mt-2"><i class="bi bi-calculator"></i> Installment amount will be calculated automatically</li>
                        <li class="mt-2"><i class="bi bi-calendar-check"></i> Deductions start from the selected month</li>
                        <li class="mt-2"><i class="bi bi-check-circle text-success"></i> Requires approval from management</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            function updateMonths() {
                var total = parseFloat($("#LoanApplication_LoanAmount").val());
                var emi = parseFloat($("#emiInput").val());
                
                if (total > 0 && emi > 0) {
                    var months = Math.ceil(total / emi);
                    $("#calcMonths").text(months);
                    $("#monthsFeedback").slideDown(200);
                } else {
                    $("#monthsFeedback").slideUp(200);
                }
            }

            $("#emiInput, #LoanApplication_LoanAmount").on('input', updateMonths);

            $("#isOngoing").change(function() {
                if($(this).is(":checked")) {
                    $("#migrationField").slideDown(200);
                } else {
                    $("#migrationField").slideUp(200);
                    $("#LoanApplication_StartingPaidInstallments").val(0);
                }
            });
            
            updateMonths(); // Initial call
        });
    </script>
}
