@page
@model AttendanceUI.Pages.Regularizations.BulkCreateModel
@{
    ViewData["Title"] = "Bulk Regularization";
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="bg-soft-primary stat-icon me-3">
                                <i class="bi bi-stack"></i>
                            </div>
                            <div>
                                <h4 class="mb-0">Bulk Regularization</h4>
                                <p class="text-muted small mb-0">Process multiple punches for an employee across a date range.</p>
                            </div>
                        </div>
                        <a asp-page="Index" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
                            <i class="bi bi-arrow-left me-1"></i> Back to List
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger soft-alert mb-4" role="alert"></div>

                        <div class="row g-4">
                            <!-- Left Column: Employee & Basic Details -->
                            <div class="col-lg-5">
                                <div class="p-4 bg-light rounded-4 h-100 border">
                                    <h6 class="fw-bold mb-4 d-flex align-items-center">
                                        <span class="badge bg-primary rounded-circle me-2 p-1 px-2">1</span> 
                                        Select Employee
                                    </h6>
                                    
                                    <div class="mb-4">
                                        <label asp-for="Input.EmployeeId" class="form-label fw-medium">Employee</label>
                                        <select asp-for="Input.EmployeeId" asp-items="ViewBag.Employees" class="form-select select2-modern" id="employeeSelect">
                                            <option value="">-- Select Employee --</option>
                                        </select>
                                        <span asp-validation-for="Input.EmployeeId" class="text-danger small"></span>
                                        <div class="form-text small mt-2">
                                            <i class="bi bi-info-circle me-1"></i> 
                                            Employee's shift times will be auto-filled.
                                        </div>
                                    </div>

                                    <div class="mb-0">
                                        <label asp-for="Input.Reason" class="form-label fw-medium">Reason / Remarks</label>
                                        <textarea asp-for="Input.Reason" class="form-control" rows="4" placeholder="e.g., Device offline, Field work..."></textarea>
                                        <span asp-validation-for="Input.Reason" class="text-danger small"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Period, Punches & Actions -->
                            <div class="col-lg-7">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <h6 class="fw-bold mb-3 d-flex align-items-center">
                                            <span class="badge bg-primary rounded-circle me-2 p-1 px-2">2</span> 
                                            Period and Punch Details
                                        </h6>
                                    </div>

                                    <div class="col-md-6">
                                        <label asp-for="Input.StartDate" class="form-label fw-medium small">Start Date</label>
                                        <input asp-for="Input.StartDate" type="date" class="form-control form-control-sm" />
                                        <span asp-validation-for="Input.StartDate" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="Input.EndDate" class="form-label fw-medium small">End Date</label>
                                        <input asp-for="Input.EndDate" type="date" class="form-control form-control-sm" />
                                        <span asp-validation-for="Input.EndDate" class="text-danger small"></span>
                                    </div>

                                    <!-- Application Number -->
                                    <div class="col-12">
                                        <div class="card bg-light border-0">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <label class="form-label fw-medium mb-0 small text-uppercase">Application Number</label>
                                                    <div class="form-check form-switch small">
                                                        <input class="form-check-input" type="checkbox" asp-for="Input.AutoGenerate" id="autoGenCheck">
                                                        <label class="form-check-label" for="autoGenCheck">Auto-Generate</label>
                                                    </div>
                                                </div>
                                                <div id="manualAppNoContainer" class="mt-2" style="display:none;">
                                                    <input asp-for="Input.ApplicationNumber" class="form-control form-control-sm" placeholder="Manual App # (Optional)" />
                                                    <span asp-validation-for="Input.ApplicationNumber" class="text-danger small"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Punch In/Out Settings -->
                                    <div class="col-12">
                                        <div class="card border">
                                            <div class="card-body p-3">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch mb-2">
                                                            <input class="form-check-input" type="checkbox" asp-for="Input.IncludeIn" id="checkIn">
                                                            <label class="form-check-label fw-bold small" for="checkIn">Include IN Punch</label>
                                                        </div>
                                                        <div id="inTimeContainer">
                                                            <input asp-for="Input.InTime" type="time" class="form-control form-control-sm" id="inTimeInput" />
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch mb-2">
                                                            <input class="form-check-input" type="checkbox" asp-for="Input.IncludeOut" id="checkOut">
                                                            <label class="form-check-label fw-bold small" for="checkOut">Include OUT Punch</label>
                                                        </div>
                                                        <div id="outTimeContainer">
                                                            <input asp-for="Input.OutTime" type="time" class="form-control form-control-sm" id="outTimeInput" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Smart Fill -->
                                    <div class="col-12" id="smartFillContainer" style="display:none;">
                                        <div class="alert alert-info border-0 mb-0 py-2">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" asp-for="Input.SmartFill" id="smartFillCheck">
                                                <label class="form-check-label fw-bold small" for="smartFillCheck">
                                                    Smart Fill: Only fill missing punches
                                                </label>
                                                <div class="small opacity-75">Automatically detects and fills only gaps in logs.</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Summary Table -->
                                    <div class="col-12" id="rangeSummaryContainer" style="display:none;">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary py-2 small fw-bold text-white border-0">
                                                <i class="bi bi-calendar3 me-1"></i> Date-wise Punch Status
                                            </div>
                                            <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
                                                <table class="table table-sm table-modern-small mb-0">
                                                    <thead class="bg-light sticky-top">
                                                        <tr>
                                                            <th class="ps-3 border-0">Date (Day)</th>
                                                            <th class="border-0">IN</th>
                                                            <th class="border-0">OUT</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="rangeSummaryList">
                                                        <!-- AJAX filled -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Auto Approve -->
                                    <div class="col-12">
                                        <div class="p-3 border rounded-3 bg-soft-primary">
                                            <div class="form-check mb-0">
                                                <input class="form-check-input" type="checkbox" asp-for="Input.AutoApprove" id="autoApprove">
                                                <label class="form-check-label fw-bold text-primary" for="autoApprove">
                                                    Submit and Approve Automatically
                                                </label>
                                                <div class="form-text small">Process attendance Immediately for these dates.</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-2">
                                        <button type="submit" class="btn btn-primary w-100 py-2 d-flex align-items-center justify-content-center gap-2" onclick="return confirm('Are you sure you want to process these records?')">
                                            <i class="bi bi-gear-fill"></i> Generate Regularization
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .soft-alert {
        background-color: #fee2e2;
        border: none;
        color: #991b1b;
        border-radius: 0.5rem;
    }
    .bg-soft-primary {
        background-color: #e0e7ff;
    }
    .table-modern-small {
        font-size: 0.85rem;
    }
    .table-modern-small th {
        padding: 0.5rem 0.75rem;
        background: #f8fafc;
        text-transform: uppercase;
        font-size: 0.75rem;
        color: #64748b;
    }
    .table-modern-small td {
        padding: 0.5rem 0.75rem;
        vertical-align: middle;
    }
    .select2-modern {
        border-radius: 0.5rem;
    }
</style>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            $('#employeeSelect').change(function() {
                var empId = $(this).val();
                if (!empId) {
                    $('#smartFillContainer, #rangeSummaryContainer').hide();
                    return;
                }

                $('#smartFillContainer').fadeIn();
                $.get('?handler=ShiftTimes&employeeId=' + empId + '&v=' + new Date().getTime(), function(data) {
                    if (data) {
                        $('#inTimeInput').val(data.inTime);
                        $('#outTimeInput').val(data.outTime);
                    }
                });
                updateRangeSummary();
            });

            $('input[type="date"]').on('change input', updateRangeSummary);

            function updateRangeSummary() {
                var empId = $('#employeeSelect').val();
                var start = $('#Input_StartDate').val() || $('input[name="Input.StartDate"]').val();
                var end = $('#Input_EndDate').val() || $('input[name="Input.EndDate"]').val();

                if (!empId || !start || !end) return;

                $.get('?handler=RangeSummary&employeeId=' + empId + '&startDate=' + start + '&endDate=' + end + '&v=' + new Date().getTime(), function (data) {
                    if (data && data.length > 0) {
                        var html = '';
                        var hasGaps = false;
                        data.forEach(function(item) {
                            var rowClass = item.isMissing ? 'table-warning' : '';
                            if (item.isMissing) hasGaps = true;

                            html += `<tr class="${rowClass}">
                                        <td class="ps-3 fw-bold">${item.date}</td>
                                        <td>${item.inTime}</td>
                                        <td>${item.outTime}</td>
                                     </tr>`;
                        });
                        $('#rangeSummaryList').html(html);
                        $('#rangeSummaryContainer').fadeIn();
                        
                        if (hasGaps) {
                             $('#smartFillCheck').prop('checked', true);
                             $('#smartFillContainer').removeClass('alert-info').addClass('alert-warning');
                        } else {
                             $('#smartFillContainer').removeClass('alert-warning').addClass('alert-info');
                        }
                    } else {
                        $('#rangeSummaryContainer').fadeOut();
                    }
                });
            }

            $('#checkIn').change(function() {
                $('#inTimeContainer').css('opacity', this.checked ? '1' : '0.4');
                $('#inTimeInput').prop('disabled', !this.checked);
            }).trigger('change');

            $('#checkOut').change(function() {
                $('#outTimeContainer').css('opacity', this.checked ? '1' : '0.4');
                $('#outTimeInput').prop('disabled', !this.checked);
            }).trigger('change');

            $('#autoGenCheck').change(function() {
                if(this.checked) {
                    $('#manualAppNoContainer').slideUp();
                } else {
                    $('#manualAppNoContainer').slideDown();
                }
            }).trigger('change');
        });
    </script>
}
